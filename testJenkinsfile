pipeline {
    agent {
        docker {
            image 'node'  // Use Node.js Docker image for the entire pipeline
            args '-u root'  // Run as root user to avoid permission issues
        }
    }

    stages {
        stage('Clean Workspace') {
            steps {
                // Remove all files and directories in the workspace
                sh 'rm -rf *'
            }
        }

        stage('Install Dependencies') {
            steps {
                // Override the default .npm cache directory to a writable location
                sh 'npm install --cache .npm --prefer-offline'
            }
        }

        stage('Package Application') {
            steps {
                // Package the application
                sh 'npm pack'
            }
        }

        stage('Upload App to Artifact') {
            steps {
                // Upload the application to Artifactory using the IP address
                sh '''
                    curl -u admin:AP8gcgmmset5jeYChTJYDN6XmDd \
                    -T my-app-1.2.0.tgz \
                    "http://54.144.115.138:8081/artifactory/myapp-nodejs/my-app-${BUILD_ID}.tgz"
                '''
            }
        }
    }
}
